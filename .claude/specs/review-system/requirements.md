# Vocabulary Review System 需求文档

## 功能概述

Vocabulary Review System是一个基于LLM生成的个性化词汇复习系统，旨在解决用户"背-忘-再背"循环严重、复习任务常被打断、阅读材料不匹配等问题。系统通过生成真实风格但按需生成的短句/短段，围绕"今天应复习的词"进行微阅读练习，并通过简洁反馈形成数据闭环，让系统越来越懂用户。

## 用户故事与验收标准

### 1. 作为学习者，我想要系统自动为我安排复习计划，以便我能够按照科学的间隔重复方法复习词汇

**验收标准：**
1.1. 系统能够基于FSRS算法为每个用户词汇计算下次复习时间
1.2. 系统能够从用户的收藏词汇中筛选出今天需要复习的词汇
1.3. 系统能够处理新添加的词汇，为其分配初始复习状态
1.4. 系统能够根据用户的复习反馈（again/hard/good/easy/unknown）更新词汇的熟悉度和下次复习时间
1.5. 系统能够处理复习间隔的延长和缩短，确保复习效果

### 2. 作为学习者，我想要系统为我生成包含目标词汇的自然句子，以便我能够在真实语境中复习词汇

**验收标准：**
2.1. 系统能够接收目标词汇列表（最多8个词汇）
2.2. 系统能够调用LLM生成包含所有目标词汇的自然英语句子
2.3. 生成的句子必须包含所有指定的目标词汇，每个词汇至少出现一次
2.4. 生成的句子长度必须在指定范围内（默认12-22个token）
2.5. 生成的句子风格应符合用户偏好（neutral/news/dialog/academic）
2.6. 系统能够识别并标记目标词汇在句子中的位置（begin/end索引）

### 3. 作为学习者，我想要系统控制生成内容的难度，以便我能够获得适合我当前水平的练习材料

**验收标准：**
3.1. 系统能够根据用户的CEFR等级（A1-C2）控制生成内容的整体难度
3.2. 系统能够限制每句话中允许的新词汇数量（默认最多2个）
3.3. 系统能够通过LLM自评功能评估生成内容的难度
3.4. 系统能够记录并返回生成内容中可能的新词汇及其释义
3.5. 系统能够根据用户的历史反馈调整难度偏好（difficulty_bias）

### 4. 作为学习者，我想要对复习内容提供快速反馈，以便系统能够根据我的反馈调整后续的练习难度

**验收标准：**
4.1. 系统能够接收用户对每个目标词汇的复习结果（again/hard/good/easy/unknown）
4.2. 系统能够接收用户对整个句子的难度反馈（too_hard/ok/too_easy）
4.3. 系统能够根据用户的难度反馈调整difficulty_bias和unknown_budget
4.4. 系统能够使用EWMA算法平滑处理用户的反馈数据
4.5. 系统能够确保反馈调整在合理范围内（difficulty_bias: -1.5到+1.5）

### 5. 作为学习者，我想要系统在生成失败时进行重试，以便我能够获得有效的复习内容

**验收标准：**
5.1. 当LLM生成失败时，系统能够自动重试生成
5.2. 当生成内容不符合基础校验规则时，系统能够重新生成
5.3. 系统能够设置合理的重试次数限制，避免无限重试
5.4. 系统能够记录生成失败的原因和重试次数
5.5. 系统能够在多次重试失败后返回明确的错误信息

### 6. 作为学习者，我想要系统记录我的复习历史，以便我能够追踪学习进度和效果

**验收标准：**
6.1. 系统能够记录每次复习事件的详细信息（时间戳、词汇、结果、延迟等）
6.2. 系统能够记录生成内容的元数据（predicted_cefr、estimated_new_terms_count等）
6.3. 系统能够维护用户词汇的状态台账（熟悉度、成功次数、失败次数等）
6.4. 系统能够记录用户的难度偏好设置
6.5. 系统能够支持删除收藏词汇时级联清理相关状态和事件

### 7. 作为开发者，我想要系统提供稳定的API接口，以便前端能够顺利集成复习功能

**验收标准：**
7.1. 系统提供GET /review/candidates接口，返回候选词汇和生成参数
7.2. 系统提供POST /review/submit接口，接收复习反馈并更新状态
7.3. API接口支持幂等性，避免重复提交
7.4. API接口支持速率限制，防止滥用
7.5. API接口支持用户权限验证，确保数据安全

### 8. 作为学习者，我想要在应用中看到复习功能，以便我能够方便地进行词汇复习

**验收标准：**
8.1. 在底部导航栏和侧边栏中添加"复习"tab，位于"我的收藏"和"我的"之间
8.2. 复习tab显示今日需要复习的词汇数量
8.3. 点击复习tab进入复习界面，显示生成的句子和反馈选项
8.4. 复习界面支持词汇反馈（again/hard/good/easy/unknown）和整体难度反馈（too_easy/ok/too_hard）
8.5. 复习完成后显示进度和下次复习时间
8.6. 复习界面支持返回主界面和继续复习功能
8.7. 复习tab在用户未登录时显示为禁用状态
8.8. 复习功能与现有的单词查询、收藏功能无缝集成

### 9. 作为系统管理员，我想要系统提供监控和观测能力，以便我能够了解系统运行状况

**验收标准：**
9.1. 系统能够记录关键指标（Too hard反馈占比、生成失败率等）
9.2. 系统能够监控生成内容的自评准确性
9.3. 系统能够记录API调用的延迟和成功率
9.4. 系统能够提供告警机制，及时发现异常情况
9.5. 系统能够支持A/B测试，优化生成策略

## 技术约束

- 系统必须基于现有的AI-Voca-2项目架构
- 系统必须使用Supabase作为数据库
- 系统必须支持TypeScript开发
- 系统必须使用Zod进行数据验证
- 系统必须支持Vercel部署
- 系统必须确保P95响应时间控制在1.5秒以内
- 系统必须支持单轮生成，不进行复杂的多轮对话

## 成功指标

- **学习节奏**：P7D留存复习用户的平均again占比下降≥10%（或稳定在合理阈值）
- **难度匹配**：Too hard反馈占比<25%，且生成失败率<5%
- **覆盖效率**：目标词命中率（句子中按需出现）≥98%
- **成本/时延**：单轮生成+校验P95≤1.5s
- **稳定性**：/submit幂等，删词能级联清理状态与事件

## 非目标

- 不做分义项（sense）粒度的复习
- 不接长篇阅读或段落级理解（先做句级/两句级）
- 不引入复杂模型训练流程（HLR等）
- 不落地句子，不维护大词表
- 不进行用户验收测试或用户反馈收集（作为此需求文档的一部分）
- 不使用预定义的兜底模板，LLM生成失败时直接重试或报错 